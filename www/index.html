<!DOCTYPE html>
<html>
<head>
<title>SEP Topic Explorer</title>
<script src="lib/jquery-1.11.0.min.js"></script>
<script src="lib/jquery.superdom.min.js"></script>
<script src="lib/bootstrap-2.3.2/js/bootstrap.min.js"></script>
<script src="lib/d3.v3.min.js"></script>
<script src="lib/mustache.js"></script>
<script src="lib/inpho/util.js"></script>
<!--<script src="sep.js"></script>-->
<link rel="stylesheet" type="text/css" href="lib/bootstrap-2.3.2/css/bootstrap.min.css" />
<!--<link rel="stylesheet" type="text/css" href="style.css" />-->
<style>
.y.axis text, .y.axis image {
  cursor: pointer;
  }
.y.axis g .inphoIcon {
  opacity: 0;
  }
.y.axis g:hover .inphoIcon {
  opacity: 1.0;
  }

.y.axis text, .y.axis image {
  cursor: pointer;
  }
.y.axis rect:hover {
  stroke: #fff;  
  stroke-width: 0;
  opacity: 0 !important;
}
.y.axis rect:hover .inphoIcon {
  opacity: 1 !important;
}

.bar {
    fill: steelblue;
}

.bar:hover {
    fill: brown;
}

.axis {
    font: 12px sans-serif;
}

.axis path,
.axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
}

.label {
  
  }

rect {
  opacity: 0.6;
  }

rect.hover {
  stroke: #000;
  stroke-width: 1;
  shape-rendering: crispEdges;
  cursor: crosshair;
}

rect.hover, .legend rect {
  opacity: 0.8;
}
.doc:hover rect, .doc.hover rect {
  opacity: 1.0;
  }
rect:hover {
  opacity: 1.0 !important;
}
rect:hover, .legend.hover rect{
  stroke: #000;
  stroke-width: 2;
  shape-rendering: crispEdges;
  }
.hover text {
  font-weight: bold;
}
#legend, #controls {
  position: absolute;
  overflow: visible;
}
.primary {
  text-transform: uppercase;
}
.title{ 
  font-weight: bold;
  }
/*
.primary.doc:hover, .primary.doc {
  stroke: #000;
  stroke-width: 1px;
  stroke-opacity: 1.0;
  shape-rendering: crispEdges;
}*/
</style>

</head>

<body>

<div class="container-fluid">
  <h1>The SEP Topic Explorer</h1>
  <h2 class="title"></h2>
  <p>This visualization shows the similarity of other articles in the SEP to the entry on <span class="title"></span>.  The color bands within each article's row show the topic distribution within that article, and the relative sizes of each band indicates the weight of that topic in the article.  The full width of each bar indicates the similarity to <span class="title"></span>. Each topic label and color is arbitrarily assigned, but is consistent across articles in the browser.</p>
  <p>Display options include alphabetical and topic sort. By clicking a topic, the visualization will reorder acoording to that topic's probability given each document and topic bars will reorder according to the order of topics in the highest probable document for the selected topic. Additionally, topic bars can be normalized, such that topic weights per document can be compared.</p>
  
  <p>The underlying dataset was generated using the <a href="http://github.com/inpho/vsm">InPhO VSM module's</a> Latent Dirichlet Allocation functions.  See <a href="http://en.wikipedia.org/wiki/Latent_Dirichlet_allocation">Wikipedia: Latent Dirichlet Allocation</a> for more on the LDA topic modeling approach used to generate this representation, or <a href="http://dl.acm.org/citation.cfm?id=2133826">"Probabilistic Topic Models" (Blei, 2012)</a> for a review.</p>
  
  <form action="/" method="GET" class="form-inline">
  <fieldset>
  <input type="text" name="doc" class="typeahead input-medium" placeholder="Document ID" autocomplete="off">
  <button type="submit" class="btn">Submit</button>
  </fieldset>
  </form>
  
  <div id="status" style="width:100%">
    <div class="progress loading progress-striped active">
      <div class="bar" style="width:25%">Loading documents...</div>
    </div>
  </div>
  
</div>
<script>
$.getJSON('/docs.json', function(data) {
  $(".typeahead").typeahead({source: data});
});
</script>

<div id="chart"> </div>
<div id="controls" style="display:none;">
  <strong>Display Options</strong>
  <label class="checkbox"><input class="sort" type="checkbox"> Alphabetical sort</label>
  <label class="checkbox"><input class="scale" type="checkbox"> Normalize topic bars</label>
  <button class="btn reset" onclick="resetTopicSort()" disabled>Reset Topic Sort</button>
</div>
<!--<script src="topics.js"></script>-->
<script>

var maxRows = 25;
var minCols = 2;

var docid = inpho.util.getValueForURLParam('doc') || 'epistemology';
var roottopic = inpho.util.getValueForURLParam('topic') || null;
$('.title').html('<a href="http://plato.stanford.edu/entries/'+docid+'" title="Stanford Encyclopedia of Philosophy: '+docid+'">'+docid+'</a>');
var margin = {top: 80, right: 40, bottom: 20, left: 200},
    width = 960 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

var x = d3.scale.linear()
    .range([0, width]);

var y = d3.scale.ordinal()
    .rangeRoundBands([0, height], .1, 0);

var color = d3.scale.category20c();

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("top")
    .ticks(10, "%");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");

function computeWidth(numCols) { 
  $('#legend').attr("width", margin.right + (numCols*55) + 20 + margin.right);
  $('#main').attr("width", Math.max($(window).width() - $('#legend').width() - 200 + margin.right, 750));
  $('#controls').css("left", Math.max($(window).width() - $('#legend').width() - 200 + margin.right, 750) + 40);
  width = Math.max($(window).width() - $('#legend').width() - 200 + margin.right, 750) - margin.left - margin.right;
  x = d3.scale.linear()
    .range([0, width]);
  x.domain([0,1]);
  xAxis = d3.svg.axis()
    .scale(x)
    .orient("top")
    .ticks(10, "%");
}

function computeHeight(data, numLegendRows) { 
  height = (data.length * 20);// - margin.top - margin.bottom;
  y = d3.scale.ordinal()
   .rangeRoundBands([0, height], .1, 0);
  y.domain(data.map(function(d) { return d.doc; }));
  yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");
}

var dataset;
var original_root;

var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .attr("id","main")
    .attr("class", "main")
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
    .on("mouseleave", function() {
        $(".legend rect").removeClass('hover').tooltip('hide');
      });

var legend = d3.select("#chart").append("svg")
    .attr("width", "350")
    .attr("id", "legend")
    .attr("class", "main")
  .append("g")
    .attr("transform","translate("+margin.right+","+ margin.top + ")");

function calculateTopicMap(data, scale, sortFn){
  data.forEach(function(d) {
    var sizeFactor = (scale) ? d.prob : 1.0
    var x0 = 0;
    if (sortFn) d.topicMap = color.domain()
      .sort(sortFn)
      .map(function(name) { return {name: name, x0: x0, x1: x0 += +(d.topics[name]*sizeFactor) }; });
    else d.topicMap = color.domain()
      .map(function(name) { return {name: name, x0: x0, x1: x0 += +(d.topics[name]*sizeFactor) }; });
  });
  
}

var url;
if (roottopic) url = "/topics/" + roottopic + '.json';
else url = "/docs_topics/" + docid + '.json'
d3.json(url, function(error, data) {
  $('#status .bar').css('width', '50%').text('Loading topics...');
  if (error) {
    $('#status .progress').removeClass('active progress-striped');
    $('#status .bar').addClass('bar-danger').text('Invalid document: ' + docid +'.');
    return false;
  }
  console.log(data);
  d3.json("/topics.json", function(error_top, topics) {
  $('#status .bar').css('width', '75%').text('Rendering chart...');
  if (error_top) {
    $('#status .progress').removeClass('active progress-striped');
    $('#status .bar-danger').addClass('bar-error').text('Could not load topic list.');
    return false;
  }
    console.log(topics);
  

  var legendCols = Math.max(Math.ceil(d3.keys(topics).length / Math.min(data.length, maxRows)), minCols);
  var legendFactor = Math.ceil(d3.keys(topics).length / legendCols);
  computeHeight(data,legendFactor);
  $("#main").attr("height", height + margin.top + margin.bottom);
  $("#legend").attr("height", (legendFactor * 20) + margin.top + margin.bottom);
  computeWidth(legendCols);


  x.domain([0, 1.0]);
  tops = data;
  color.domain(d3.keys(data[0].topics));
    //.sort();

  calculateTopicMap(data, true, function(a,b) {return data[0].topics[b] - data[0].topics[a];});


  dataset = data;
  original_root = data[0];

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(10,-10)")
      .call(xAxis)
    .append("text")
      //.attr("transform", "rotate(-120)")
      .attr("class", "axis_label")
      .attr("dy", "-2em")
      .style("text-anchor", "middle")
      .text("Similarity to " + docid);

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
      .selectAll("text")
      .attr("class", function(d) { return d == docid ? "primary" : "" })
      .on("click", function(d) { window.location.href = "/?doc=" + d;})

  svg.select(".y.axis").selectAll("g")
      .insert("rect", ":first-child")
        .attr("x", -margin.left + 5)
        .attr("y", -9)
        .attr("width", margin.left-5)
        .attr("height", 18)
        .style("opacity", "0");

  var ticks = svg.select(".y.axis").selectAll("g")
      .on("mouseenter", function(d) { 
        $('text', this).attr('text-decoration', 'underline')
          .attr('font-weight', 'bold');     
        svg.selectAll(".doc").filter(function(doc,i) { return doc.doc == d}).attr("class", "doc hover"); 
        })
      .on("mouseleave", function(d) { 
        $('text',this).removeAttr('text-decoration')
          .removeAttr('font-weight'); 
        svg.selectAll(".doc").filter(function(doc,i) { return doc.doc == d}).attr("class", "doc"); })
      .append("svg:image")
        .attr("xlink:href","/img/inpho.png")
        .attr("width", 18)
        .attr("height",18)
        .attr("x", -margin.left + 5)
        .attr("y", -9)
        //.attr("x", -9)
        .attr("class", "inphoIcon")
        .on("click", function(d) { window.open("https://inpho.cogs.indiana.edu/entity?redirect=True&sep=" + d, "_blank");});

      //.on("click", function(d) { window.open("http://plato.stanford.edu/entires/" + d, "_blank");});

  // draw total bar
  var doc = svg.selectAll("doc")
      .data(data)
    .enter().append("g")
      .attr("class", function(d) { return d.doc == docid ? "doc primary" : "doc"})
      .attr("transform", function(d) { return "translate(10," + y(d.doc) + ")"; })
      .on("mouseover", function(d) {
          $("text:contains(" + d.doc +")")
            .filter(function() {return $(this).text().trim() == d.doc })
            .attr("font-weight", "bold")
            .next(".inphoIcon").css('opacity', '1.0');
        })
      .on("mouseout", function(d) {
          $("text:contains(" + d.doc +")")
            .filter(function() {return $(this).text().trim() == d.doc })
            .attr("font-weight", "normal")
            .next(".inphoIcon").css('opacity', '');
        });

  // Draw topic bars
  doc.selectAll("rect")
      .data(function(d) { return d.topicMap; })
    .enter().append("rect")
      .attr("height", y.rangeBand())
      .attr("x", function(d) { return x(d.x0); })
      .attr("width", function(d) { return x(d.x1) - x(d.x0); })
      .attr("class", function(d) { return "top_" + d.name; })
      .on("mouseover", function(d) {
          // SVG element z-index determined by render order, not style sheet
          // so element must be reappended to the end on hover so border 
          // is not occluded
          var parent = $(this).parent();
          $(this).detach().appendTo(parent);
          $('.legend rect').not('.top_' + d.name).tooltip('hide');
          $(".top_" + d.name).addClass('hover');
          $('.legend rect.top_' + d.name).tooltip('show');
        })
      .on("mouseout", function(d) {
          $(".top_" + d.name).removeClass('hover');
        })
      .on("click", function(d) { topicSort(d.name); })
      .style("fill", function(d) { return color(d.name); });

  var legendElts = legend.selectAll(".legend")
      .data(color.domain().slice())
      //.data(d3.keys(data[0].topics))
    .enter().append("g")
      .attr("class", function(d) { return "legend top_" + d; })
      .attr("transform", function(d, i) { return "translate("+(55 * Math.floor(i / legendFactor))+"," + y(i % legendFactor) + ")"; });

  legendElts.append("rect")
      .attr("width", 18)
      .attr("height", 18)
      .attr("class", function(d) { return "top_" + d; })
      .style("fill", color)
      //.attr("data-toggle", "tooltip")
      .attr("data-placement", "right")
      .attr("title", function(d) { return d3.keys(topics[d]).join(", ") + ", ..."; })
      .on("click", function(d) { topicSort(d); })
      .on("mouseover", function(d) {
          $(".top_" + d).addClass('hover').tooltip('show');
        })
      .on("mouseout", function(d) {
          $(".top_" + d).removeClass('hover').tooltip('hide');
        });

  $(".legend rect").tooltip({container:'body', trigger: 'manual', animation: false});

  legendElts.append("text")
      .attr("dx", -6)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .text(function(d) { return d; });


  legend.append("text")
      .attr("dx", -6)
      .attr("dy", "-.35em")
      .attr("font-weight", "bold")
      .style("text-anchor", "end")
      .text(d3.keys(topics).length);
  legend.append("text")
      //.attr("transform", "rotate(-120)")
      .attr("class", "axis_label")
      .attr("dy", "-.35em")
      .attr("font-weight", "bold")
      .style("text-anchor", "start")
      .text("Topics");
  legend.append("text")
      //.attr("transform", "rotate(-120)")
      .attr("class", "axis_label")
      .attr("dy", "-.45em")
      .attr("dx", "5em")
      .attr("font-size", "10px")
      .style("text-anchor", "start")
      .text("ordered by P( T | " + docid + " )");

  d3.select(window).on('resize', resize);

  function resize() {
    computeWidth(legendCols);

    /* Update the axis with the new scale */
    svg.select('.x.axis')
      .call(xAxis);

    doc.selectAll('rect')
      .attr("x", function(d) { return x(d.x0); })
      .attr("width", function(d) { return x(d.x1) - x(d.x0); });
  }



  d3.select(".sort").on("change", alphabetSort);
  
  $('#status .bar').addClass('bar-success').css('width', '100%').text("Complete!");
  setTimeout(function() { 
    $('#status').hide(500);
    setTimeout(function() {$('#controls').css({'top' : $('#legend').height() + $('#legend').position().top}).show();}, 500);
    } , 500);

  $(window).on("scroll", scrollLegend);
  function scrollLegend() {
    var scrollPos = $(window).scrollTop();
    var chartHeight = $('#chart').position().top;
    var legendHeight = $('#legend').height();
    var heightFac = -60;
    if((scrollPos - chartHeight - margin.top - heightFac) <= 0) {
      $('#legend').css({'position': 'absolute', 'top' : chartHeight});
      $('#controls').css({'position': 'absolute', 'top' : legendHeight + chartHeight});
    } else if ((scrollPos - chartHeight - heightFac) < (margin.top)) {
      $('#legend').css({'position': 'absolute', 'top' : scrollPos + heightFac});
      $('#controls').css({'position': 'absolute', 'top' : legendHeight+ scrollPos + heightFac});
    } else {
      $('#legend').css({'position': 'fixed', 'top' : heightFac});
      $('#controls').css({'position': 'fixed', 'top' : legendHeight + heightFac});
    }}
   
$('.inphoIcon').tooltip({placement: 'top', title: 'Click to see more information<br /> at the InPhO Project.', container: 'body', html: true, animation: false});
}); });

  function scaleTopics() {
    var numTopics = dataset[0].topics.length;
    var delay = function(d, i) { return i * (500/numTopics); },
        negdelay = function(d, i) { return (numTopics-i) * (500/numTopics); };

    calculateTopicMap(dataset, !this.checked);

    $(".doc").each(function(i,elt) {
        $(elt).children()
          .sort(function(a,b) { return $(a).attr('x') - $(b).attr('x'); })
          .each(function(j,child) {
            $(child).detach().appendTo($(elt));
        })
      });

    svg.selectAll(".doc")
      .selectAll("rect")
      .data(function(d) { return d.topicMap; })
      .style("fill", function(d) { return color(d.name); })
      .on("mouseover", function(d) {
          // SVG element z-index determined by render order, not style sheet
          // so element must be reappended to the end on hover so border 
          // is not occluded
          var parent = $(this).parent();
          $(this).detach().appendTo(parent);
          $('.legend rect').not('.top_' + d.name).tooltip('hide');
          $(".top_" + d.name).addClass('hover');
          $('.legend rect.top_' + d.name).tooltip('show');
        })
      .on("mouseout", function(d) {
          $(".top_" + d.name).removeClass('hover');
        })
      .transition().duration(500).ease("linear").delay(this.checked ? delay : negdelay)
      .attr("x", function(d) { return x(d.x0); })
      .attr("width", function(d) { return x(d.x1) - x(d.x0); })
      .attr("class", function(d) { return "top_" + d.name; });

    svg.selectAll(".x.axis text.axis_label").text(this.checked ? 
      "Proportion of document assigned to topic" : ("Similarity to " + docid));
  }

  d3.select(".scale").on("change", scaleTopics);
  function sortDataset(sortFn) {
    dataset = dataset.sort(sortFn);

    var y0 = y.domain(dataset
        .map(function(d) { return d.doc; }))
        .copy();

    var transition = svg.transition().duration(500),
        delay = function(d, i) { return i * 25; };

    transition.selectAll(".doc")
        .delay(delay)
        .attr("transform", function(d) { return "translate(10," + y(d.doc) + ")"; });
        //.attr("y", function(d) { return y(d.doc); });

    transition.select(".y.axis")
        .call(yAxis)
      .selectAll("g")
        .selectAll("text")
        .delay(delay);
  }

  function alphabetSort() {
    // Copy-on-write since tweens are evaluated after a delay.
    if (this.checked)
      sortDataset(function(a, b) { return d3.ascending(a.doc, b.doc); });
    else
      sortDataset(function(a, b) { return b.prob - a.prob; });
  }

  function resetTopicSort() {
    $('.reset').attr('disabled',true);
    topicSort(null);
  }

  function topicSort(topic) {
    // Copy-on-write since tweens are evaluated after a delay.
    $('.sort').removeAttr('checked');
    if (topic) {
      sortDataset(function(a, b) { return b.topics[topic] - a.topics[topic]; });
      $('.reset').removeAttr('disabled');
    } else
      sortDataset(function(a, b) { return b.prob - a.prob; });


    var sortFn = function(a,b) {
      if (a == topic) return -1;
      else if (b == topic) return 1;
      else return dataset[0].topics[b] - dataset[0].topics[a];
      //else return original_root.topics[b] - original_root.topics[a];
    } 
    redrawBars(sortFn);
  }

  function redrawBars(sortFn) { 
    $("#legend .hover").removeClass("hover");
    var numTopics = dataset[0].topics.length;
    var delay = function(d, i) { return i * (1000/numTopics); },
        negdelay = function(d, i) { return (numTopics-i) * (1000/numTopics); };
    calculateTopicMap(dataset, !($('.scale')[0].checked), sortFn);
    
    svg.selectAll(".doc")
      .selectAll("rect")
      .data(function(d) { return d.topicMap; })
      .style("fill", function(d) { return color(d.name); })
      .on("mouseover", function(d) {
          // SVG element z-index determined by render order, not style sheet
          // so element must be reappended to the end on hover so border 
          // is not occluded
          var parent = $(this).parent();
          $(this).detach().appendTo(parent);
          $('.legend rect').not('.top_' + d.name).tooltip('hide');
          $(".top_" + d.name).addClass('hover');
          $('.legend rect.top_' + d.name).tooltip('show');
        })
      .on("mouseout", function(d) {
          $(".top_" + d.name).removeClass('hover');
        })
      .transition().duration(1000).ease("linear").delay(this.checked ? delay : negdelay)
      .attr("x", function(d) { return x(d.x0); })
      .attr("width", function(d) { return x(d.x1) - x(d.x0); })
      .attr("class", function(d) { return "top_" + d.name; });

  }


</script>

</body>
</html>
